name: e2e
on: 
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest


    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Add custom host entry
      run: echo "127.0.0.1 to-dos.local.tourmalinecore.internal" | sudo tee -a /etc/hosts

    - name: Verify host entry
      run: cat /etc/hosts

    - name: Set up Docker
      uses: docker/setup-buildx-action@v3

    # - name: Install kind
    #   uses: helm/kind-action@v1.5.0

    - name: Create cluster
      run: kind create cluster --name to-dos --config kind-local-config.yaml --kubeconfig ./.to-dos-cluster-kubeconfig
      
    - name: Set up Helmfile
      uses: helmfile/helmfile-action@v1.0.0
      with:
        helmfile-args: apply
        helmfile-version: 'v0.150.0'
        helm-version: 'v3.11.0'
        helmfile-workdirectory: 'deploy'

    - name: check helm
      run: helm

    - name: Apply helmfile
      run: helmfile cache cleanup && helmfile --environment local --namespace local -f deploy/helmfile.yaml apply
